<!DOCTYPE html>
<html lang="en">
<head>
  <title>Intruder Alarm Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/style.css" />
  <style>
    body {
      /* Replace the URL below with your desired image/link */
      background-image: url(/public/img/image.png);
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center center;
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <h1 class="title" style="text-align: center;">Intruder Alarm System</h1>
  <div id="controls" class="container">
    <h2>System Controls</h2>
    <div style="margin-bottom:12px;">
      <label>ESP32-CAM:</label>
      <button id="arm-esp32">Arm</button>
      <button id="disarm-esp32">Disarm</button>
      <span id="esp32-status" class="status"></span>
      <span id="esp32-connection-status" class="status">Checking...</span>
    </div>
    <div>
      <label>Arduino Uno:</label>
      <button id="arm-arduino">Arm</button>
      <button id="disarm-arduino">Disarm</button>
      <span id="arduino-status" class="status"></span>
      <span id="arduino-connection-status" class="status">Checking...</span>
    </div>
  </div>
  <div id="hardware-status" class="container">
    <h2>Hardware Status</h2>
    <div id="esp32-hardware-status" class="status">...</div>
    <div id="arduino-hardware-status" class="status">...</div>
  </div>
  <div id="alert" class="container">
    <h2>Alerts</h2>
    <div id="alert-content">No alerts.</div>
  </div>
  <div id="snapshot-gallery" class="container">
    <h2>Snapshots</h2>
    <button id="show-gallery-btn">Show Gallery</button>
    <button id="hide-gallery-btn" style="display:none;">Hide Gallery</button>
    <div id="snapshots"></div>
  </div>
  <!-- Modal for viewing snapshot -->
  <div id="snapshot-modal">
    <div id="snapshot-modal-content">
      <button id="snapshot-modal-close">&times;</button>
      <img id="snapshot-modal-img" src="" alt="Snapshot" />
      <div id="snapshot-modal-timestamp" class="timestamp"></div>
    </div>
  </div>

  <script>
    // ThingSpeak endpoints and channel info
    const THINGSPEAK_CHANNEL_ID = "3033231";
    const THINGSPEAK_READ_API_KEY = "N6598QTZTIAWCV0H";
    const THINGSPEAK_WRITE_API_KEY = "KOU513ED704T5O07";
    const ARM_FIELD = 5;           // ESP32 ARM field
    const ARDUINO_ARM_FIELD = 6;   // Arduino ARM field
    const ARDUINO_HEARTBEAT_FIELD = 4;
    const STATUS_FIELD = 3;        // ESP32 heartbeat/status

    // --- ESP32 Arm/Disarm ---
    let armPending = false;
    let lastArmRequested = null;
    async function pollEsp32ArmStatus(fastPoll = false) {
      const url = `https://api.thingspeak.com/channels/${THINGSPEAK_CHANNEL_ID}/fields/${ARM_FIELD}/last.json?api_key=${THINGSPEAK_READ_API_KEY}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("ThingSpeak fetch failed");
        const data = await res.json();
        const armed = data[`field${ARM_FIELD}`] === "1";
        const statusElem = document.getElementById("esp32-status");
        if (armPending) {
          if (
            (lastArmRequested === "arm" && armed) ||
            (lastArmRequested === "disarm" && !armed)
          ) {
            armPending = false;
            lastArmRequested = null;
            statusElem.innerText = armed ? "Armed" : "Disarmed";
          } else {
            statusElem.innerText = lastArmRequested === "arm" ? "Arming..." : "Disarming...";
            setTimeout(() => pollEsp32ArmStatus(true), 1500);
            return;
          }
        } else {
          statusElem.innerText = armed ? "Armed" : "Disarmed";
        }
      } catch (err) {
        document.getElementById("esp32-status").innerText = "Status Error";
      }
    }
    document.getElementById("arm-esp32").onclick = async function () {
      armPending = true;
      lastArmRequested = "arm";
      document.getElementById("esp32-status").innerText = "Arming...";
      await fetch(`https://api.thingspeak.com/update?api_key=${THINGSPEAK_WRITE_API_KEY}&field${ARM_FIELD}=1`);
      pollEsp32ArmStatus(true);
    };
    document.getElementById("disarm-esp32").onclick = async function () {
      armPending = true;
      lastArmRequested = "disarm";
      document.getElementById("esp32-status").innerText = "Disarming...";
      await fetch(`https://api.thingspeak.com/update?api_key=${THINGSPEAK_WRITE_API_KEY}&field${ARM_FIELD}=0`);
      pollEsp32ArmStatus(true);
    };
    setInterval(() => { if (!armPending) pollEsp32ArmStatus(); }, 5000);

    // --- Arduino Arm/Disarm ---
    let arduinoArmPending = false;
    let arduinoLastArmRequested = null;
    async function pollArduinoArmStatus(fastPoll = false) {
      const url = `https://api.thingspeak.com/channels/${THINGSPEAK_CHANNEL_ID}/fields/${ARDUINO_ARM_FIELD}/last.json?api_key=${THINGSPEAK_READ_API_KEY}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("ThingSpeak fetch failed");
        const data = await res.json();
        const armed = data[`field${ARDUINO_ARM_FIELD}`] === "1";
        const statusElem = document.getElementById("arduino-status");
        if (arduinoArmPending) {
          if (
            (arduinoLastArmRequested === "arm" && armed) ||
            (arduinoLastArmRequested === "disarm" && !armed)
          ) {
            arduinoArmPending = false;
            arduinoLastArmRequested = null;
            statusElem.innerText = armed ? "Armed" : "Disarmed";
          } else {
            statusElem.innerText = arduinoLastArmRequested === "arm" ? "Arming..." : "Disarming...";
            setTimeout(() => pollArduinoArmStatus(true), 1500);
            return;
          }
        } else {
          statusElem.innerText = armed ? "Armed" : "Disarmed";
        }
      } catch (err) {
        document.getElementById("arduino-status").innerText = "Status Error";
      }
    }
    document.getElementById("arm-arduino").onclick = async function () {
      arduinoArmPending = true;
      arduinoLastArmRequested = "arm";
      document.getElementById("arduino-status").innerText = "Arming...";
      await fetch(`https://api.thingspeak.com/update?api_key=${THINGSPEAK_WRITE_API_KEY}&field${ARDUINO_ARM_FIELD}=1`);
      pollArduinoArmStatus(true);
    };
    document.getElementById("disarm-arduino").onclick = async function () {
      arduinoArmPending = true;
      arduinoLastArmRequested = "disarm";
      document.getElementById("arduino-status").innerText = "Disarming...";
      await fetch(`https://api.thingspeak.com/update?api_key=${THINGSPEAK_WRITE_API_KEY}&field${ARDUINO_ARM_FIELD}=0`);
      pollArduinoArmStatus(true);
    };
    setInterval(() => { if (!arduinoArmPending) pollArduinoArmStatus(); }, 5000);

    // --- Arduino hardware status via ThingSpeak heartbeat (field4) ---
    async function pollArduinoHardwareStatus() {
      const url = `https://api.thingspeak.com/channels/${THINGSPEAK_CHANNEL_ID}/fields/${ARDUINO_HEARTBEAT_FIELD}/last.json?api_key=${THINGSPEAK_READ_API_KEY}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("ThingSpeak heartbeat fetch failed");
        const data = await res.json();
        const lastUpdateTime = new Date(data.created_at);
        const now = new Date();
        const secondsAgo = (now - lastUpdateTime) / 1000;
        const online = secondsAgo < 30;
        const hwStatus = document.getElementById("arduino-hardware-status");
        if (online) {
          hwStatus.innerText = `Online (last seen ${Math.floor(secondsAgo)}s ago)`;
          hwStatus.classList.add("online");
          hwStatus.classList.remove("offline");
          document.getElementById("arduino-connection-status").innerText = "Online";
          document.getElementById("arduino-connection-status").classList.remove("offline");
        } else {
          hwStatus.innerText = `Offline (last seen ${Math.floor(secondsAgo)}s ago)`;
          hwStatus.classList.add("offline");
          hwStatus.classList.remove("online");
          document.getElementById("arduino-connection-status").innerText = "Offline";
          document.getElementById("arduino-connection-status").classList.add("offline");
        }
      } catch (err) {
        const hwStatus = document.getElementById("arduino-hardware-status");
        hwStatus.innerText = "Status Error";
        hwStatus.classList.remove("online");
        hwStatus.classList.add("offline");
        document.getElementById("arduino-connection-status").innerText = "Status Error";
        document.getElementById("arduino-connection-status").classList.add("offline");
      }
    }

    // --- ESP32 hardware status via ThingSpeak heartbeat (field3) ---
    async function pollEsp32HardwareStatus() {
      const url = `https://api.thingspeak.com/channels/${THINGSPEAK_CHANNEL_ID}/fields/${STATUS_FIELD}/last.json?api_key=${THINGSPEAK_READ_API_KEY}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("ThingSpeak status fetch failed");
        const data = await res.json();
        const lastUpdateTime = new Date(data.created_at);
        const now = new Date();
        const secondsAgo = (now - lastUpdateTime) / 1000;
        const online = secondsAgo < 30;
        const hwStatus = document.getElementById("esp32-hardware-status");
        if (online) {
          hwStatus.innerText = `Online (last seen ${Math.floor(secondsAgo)}s ago)`;
          hwStatus.classList.add("online");
          hwStatus.classList.remove("offline");
          document.getElementById("esp32-connection-status").innerText = "Online";
          document.getElementById("esp32-connection-status").classList.remove("offline");
        } else {
          hwStatus.innerText = `Offline (last seen ${Math.floor(secondsAgo)}s ago)`;
          hwStatus.classList.add("offline");
          hwStatus.classList.remove("online");
          document.getElementById("esp32-connection-status").innerText = "Offline";
          document.getElementById("esp32-connection-status").classList.add("offline");
        }
      } catch (err) {
        const hwStatus = document.getElementById("esp32-hardware-status");
        hwStatus.innerText = "Status Error";
        hwStatus.classList.remove("online");
        hwStatus.classList.add("offline");
        document.getElementById("esp32-connection-status").innerText = "Status Error";
        document.getElementById("esp32-connection-status").classList.add("offline");
      }
    }

    // --- Intruder Alerts from field1 ---
    async function pollAlerts() {
    // Get 100 latest entries from field1 (intruder alerts)
    const url = `https://api.thingspeak.com/channels/${THINGSPEAK_CHANNEL_ID}/fields/1.json?api_key=${THINGSPEAK_READ_API_KEY}&results=100`;
    try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("ThingSpeak alerts fetch failed");
        const data = await res.json();
        const feeds = data.feeds || [];
        // Filter where field1 is "1", "1.0", or 1 (robust)
        let alerts = feeds.filter(f => f.field1 && parseFloat(f.field1) === 1);
        // Show the last 5 alerts (most recent first)
        alerts = alerts.slice(-5).reverse();
        const alertDiv = document.getElementById("alert-content");
        if (alerts.length === 0) {
        alertDiv.innerHTML = "<div>No alerts.</div>";
        } else {
        alertDiv.innerHTML = alerts.map(a =>
            `<div class="alert">🚨 Intruder Detected!<br>
            <span>Date/Time: ${new Date(a.created_at).toLocaleString()}</span>
            </div>`
        ).join('');
        }
    } catch (err) {
        document.getElementById("alert-content").innerHTML = "<div class='alert'>Error fetching alerts.</div>";
    }
    }

    // --- Snapshot gallery from field1 (assume URL in field1) ---
    let lastSnapshotsData = [];
    async function pollSnapshots() {
      const url =
        `https://api.thingspeak.com/channels/${THINGSPEAK_CHANNEL_ID}/feeds.json?api_key=${THINGSPEAK_READ_API_KEY}&results=21`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Snapshots fetch failed");
        const data = await res.json();
        lastSnapshotsData = data.feeds && data.feeds.length > 0
          ? data.feeds.filter(f => f.field1 && f.created_at && f.field1.startsWith("http"))
          : [];
        renderSnapshotsGallery();
      } catch (err) {
        document.getElementById("snapshots").innerHTML =
          "<div>Error loading snapshots.</div>";
      }
    }

    function renderSnapshotsGallery() {
      const snapshotsDiv = document.getElementById("snapshots");
      if (!lastSnapshotsData || lastSnapshotsData.length === 0) {
        snapshotsDiv.innerHTML = "<div>No snapshots yet.</div>";
        return;
      }
      let html = "";
      const snaps = [...lastSnapshotsData].reverse();
      for (let i = 0; i < snaps.length; i++) {
        html += `<div class="snapshot-card" data-img="${snaps[i].field1}" data-timestamp="${snaps[i].created_at}">
          <img src="${snaps[i].field1}" alt="Snapshot" />
          <div class="timestamp">${new Date(snaps[i].created_at).toLocaleString()}</div>
        </div>`;
      }
      snapshotsDiv.innerHTML = html;
      document.querySelectorAll('.snapshot-card').forEach(card => {
        card.onclick = function() {
          showSnapshotModal(
            card.getAttribute('data-img'),
            card.getAttribute('data-timestamp')
          );
        }
      });
    }

    function showSnapshotModal(img, timestamp) {
      document.getElementById("snapshot-modal-img").src = img;
      document.getElementById("snapshot-modal-timestamp").innerText = new Date(timestamp).toLocaleString();
      document.getElementById("snapshot-modal").style.display = "flex";
    }
    document.getElementById("snapshot-modal-close").onclick = function() {
      document.getElementById("snapshot-modal").style.display = "none";
    };
    document.getElementById("snapshot-modal").onclick = function(event) {
      if (event.target === this) {
        document.getElementById("snapshot-modal").style.display = "none";
      }
    };

    document.getElementById("show-gallery-btn").onclick = function() {
      document.getElementById("snapshots").style.display = "flex";
      document.getElementById("show-gallery-btn").style.display = "none";
      document.getElementById("hide-gallery-btn").style.display = "inline-block";
      pollSnapshots();
    };
    document.getElementById("hide-gallery-btn").onclick = function() {
      document.getElementById("snapshots").style.display = "none";
      document.getElementById("show-gallery-btn").style.display = "inline-block";
      document.getElementById("hide-gallery-btn").style.display = "none";
    };

    // Initial pollers
    pollEsp32ArmStatus();
    pollArduinoArmStatus();
    pollEsp32HardwareStatus();
    pollArduinoHardwareStatus();
    pollAlerts();

    setInterval(pollEsp32HardwareStatus, 10000);
    setInterval(pollArduinoHardwareStatus, 10000);
    setInterval(() => { if (!armPending) pollEsp32ArmStatus(); }, 5000);
    setInterval(() => { if (!arduinoArmPending) pollArduinoArmStatus(); }, 5000);
    setInterval(pollAlerts, 7000);

  </script>
</body>
</html>